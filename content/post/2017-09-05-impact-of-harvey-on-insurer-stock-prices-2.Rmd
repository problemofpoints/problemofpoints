---
title: Impact of Harvey on Insurer Stock Prices - Part 2
author: ''
date: '2017-09-07'
slug: impact-of-harvey-on-insurer-stock-prices-part-2
categories: []
tags:
  - stocks
subtitle: ''
draft: true
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)

library(tidyverse)
library(tidyquant)
library(CausalImpact)
library(DT)
library(widgetframe)

```

In the [prior post]({{< relref "2017-09-03-impact-of-harvey-on-insurer-stock-prices-1.html" >}}) we calculated the impact of Hurricane Harvey on U.S. P&C (re)insurer stock prices using the actual change in stock price from August 23 through September 1. It is a reasonable proxy for the impact of an event on the stock price, but we can do better.

This post does a proper [event study](https://en.wikipedia.org/wiki/Event_study) using a Google developed package called [CausalImpact](https://google.github.io/CausalImpact/CausalImpact.html). The goal of the analysis is to estimate what the stock prices *would* have been had the event, in this case Hurricane Harvey, had not occurred (this is called the counterfactual). There are many ways that we could estimate this counterfactual, but the key is to use variables that were themselves *not affected by the event*. In this case, we use the change in the S&P 500 to estimate what our returns would have been, similar to a traditional capital asset pricing model beta style approach. The CausalImpact package uses fancy statistical methods to help us to this and access reliability of our results. 

```{r set-dates}

start_event <- as_date("2017-08-23")
end_event <- as_date("2017-09-02")
start_stock <- as_date("2017-01-01")
start_graph <- end_event - weeks(6)

```


```{r import-tickers}

# get a list of all the Property-Casualty Insurers from the major US stock exchanges
stock_tickers <- list('AMEX','NASDAQ','NYSE') %>% map_df(tq_exchange) %>% 
  filter((industry == 'Property-Casualty Insurers' | symbol %in% c("AGII", "ERIE", "AIZ")) & !is.na(market.cap)) %>%
  mutate(market_cap = if_else(stringr::str_sub(market.cap,start = -1)=="M",1e6,1e9) *
           as.numeric(stringr::str_sub(market.cap,start = 2, end = -2))) %>%
  dplyr::select(symbol, company, sector, industry, market_cap) %>%
  arrange(desc(market_cap))

# get shares outstanding from most recent 10Q balance sheet; per Google finance
stock_shares <- stock_tickers %>% tq_get(get = "financials") %>% group_by(symbol) %>% 
  filter(type == "BS") %>% mutate(shares = map_dbl(quarter, ~ .x$value[.x$group == 42][1] * 1e6)) %>%
  dplyr::select(symbol, shares)

# not able to get XL shares outstanding, so manually put it in as of Q2 2017
stock_tickers <- stock_tickers %>% left_join(stock_shares, by = "symbol") %>%
  mutate(shares = if_else(symbol == "XL", 257.94 * 1e6, shares)) %>% filter(!is.na(shares))

```


```{r import-stock-prices, message=FALSE, warning=FALSE, cache=TRUE}

# now get the historical stock prices for all of the tickers; calculate daily returns
stock_prices <- stock_tickers %>% tq_get(get = "stock.prices", from = start_stock, to = end_event) %>% 
  filter(!is.na(adjusted)) %>% dplyr::group_by(symbol) %>%
  tq_mutate(select = adjusted, mutate_fun = periodReturn, period = "daily", type = "arithmetic", 
            col_rename = "daily_returns")

# get S&P 500 historical prices; use for comparison and CausalImpact calculation
sp500_price <- tibble(symbol = "SPY") %>% tq_get(get = "stock.prices", 
                                                 from = start_stock, to = end_event) %>%
  tq_mutate(select = adjusted, mutate_fun = periodReturn, period = "daily", type = "arithmetic", 
            col_rename = "daily_returns")

sp500_price <- sp500_price %>% mutate(sp500 = adjusted, sp500_returns = daily_returns)
stock_prices <- stock_prices %>% left_join(sp500_price %>% dplyr::select(date, sp500, sp500_returns), by = "date")

```


```{r cum-change}

stock_prices <- stock_prices %>% mutate(post_event = if_else(date >= start_event, 1, 0)) %>%
  group_by(symbol, post_event) %>% mutate(cum_return = if_else(post_event == 1, cumprod(1 + daily_returns) - 1, 0)) %>%
  mutate(sp500_cum_return = if_else(post_event == 1, cumprod(1 + sp500_returns) - 1, 0)) %>% ungroup()

impact_of_event <- stock_prices %>% filter(post_event == 1) %>% group_by(symbol) %>%
  summarise(company = company[1], start_price = first(open), end_price = last(adjusted), 
            cum_return = last(cum_return), sp500_cum_return = last(sp500_cum_return),
            market_cap_change = shares[1] * first(open) * cum_return) %>% ungroup() %>% 
  arrange(cum_return)

```

# Estimating what could have been

We will use TRV as an example to illustrate the methodology. The graph below shows the daily returns for TRV stock and the S&P 500 (SPY) over the six weeks prior to September 1. We need to estimate what returns could have been for the eight days highlighted in gray using the actual returns from SPY over those days. 

```{r sample-graph}

stock_prices %>% filter(symbol == 'TRV') %>% dplyr::select(symbol, date, daily_returns) %>%
  bind_rows(sp500_price %>% dplyr::select(symbol, date, daily_returns)) %>%
  filter(date >= start_graph - days(2 * 15)) %>%
  ggplot(aes(x = date, y = daily_returns, group = symbol)) +
  geom_rect(aes(xmin = start_event, xmax = end_event, 
                ymin = -Inf, ymax = +Inf, group = symbol), fill = "#F2F2F2") +
  geom_col(aes(fill = daily_returns < 0)) +
  labs(title = "P&C Insurers Daily Stock Returns (%)", 
       subtitle = "Impact of Hurricane Harvey",
       y = "Daily price change (%)", x = "") + 
  coord_x_date(xlim = c(start_graph, end_event)) +
  facet_wrap(~ symbol, scale = "fixed") + 
  AonECM::ggThemeAon() + scale_fill_tq() + theme(legend.position =  "none") +
  scale_y_continuous(labels = scales::percent_format())


```

The graph below shows the data that we will use to estimate the returns. Then cumulative index returns since January 2017 show that TRV stock does broadly move with the S&P 500. The linear correlation coefficient between the TRV and S&P 500 daily returns for this time period is around 30%.

You can clearly see the divergence in the two time series in the gray box representing the Hurricane Harvey time period.

```{r sample-graph}

stock_prices %>% filter(symbol == 'TRV') %>% dplyr::select(symbol, date, adjusted) %>%
  bind_rows(sp500_price %>% dplyr::select(symbol, date, adjusted)) %>%
  group_by(symbol) %>% mutate(index = adjusted / first(adjusted)) %>%
  ggplot(aes(x = date, y = index, group = symbol)) +
  geom_rect(aes(xmin = start_event, xmax = end_event, 
                ymin = -Inf, ymax = +Inf, group = symbol), fill = "#F2F2F2") +
  geom_line(aes(colour = symbol)) +
  labs(title = "SPY vs. TRV", 
       subtitle = "January 2017 - August 2017",
       y = "Stock price index (Jan 3, 2017 = 1.0)", x = "") + 
  coord_x_date() +
  AonECM::ggThemeAon() + scale_color_tq() + theme(legend.position = "right") +
  scale_y_continuous(labels = scales::percent_format())


```

```{r causal-impact-func}

run_causal_impact <- function(stock_data, prior_level_sd = 0.05, use_dynamic = FALSE){
  
  model_data_mat <- stock_data %>% ungroup() %>% 
    mutate(var = if_else(daily_returns > 0.02, 1, 0)) %>%
    dplyr::select(adjusted, sp500, var) %>%
    # dplyr::select(adjusted, var) %>%
    as.matrix()
  
  impact_analysis <- CausalImpact(model_data_mat,
                                  pre.period = c(1, nrow(model_data_mat) - 7),
                                  post.period = c(nrow(model_data_mat)-7+1, nrow(model_data_mat)),
                                  model.args = list(niter = 1000, prior.level.sd = prior_level_sd, 
                                                    dynamic.regression = use_dynamic))
  
  impact_analysis
}

```

Explain output. Graph and summary table.

```{r causal-impact-example}

impact_model <- run_causal_impact(stock_prices %>% filter(symbol == "TRV"), 0.05, FALSE)

plot(impact_model)
summary(impact_model)
impact_model$series[nrow(impact_model$series)]$response / impact_model$series[nrow(impact_model$series)]$point.pred - 1

graph_tbl <- stock_prices %>% filter(symbol == "TRV") %>% bind_cols(as_tibble(impact_model$series)) %>%
  dplyr::select(symbol, company, date, adjusted, point.pred, 
                point.pred.lower, point.pred.upper, point.effect, point.effect.lower, point.effect.upper) 

graph_tbl <- graph_tbl %>% dplyr::select(symbol, company, date, actual = adjusted, 
                                         fitted = point.pred, lower = point.pred.lower, upper = point.pred.upper) %>% 
  mutate(facet_var = "Stock Price") %>%
  bind_rows(graph_tbl %>% dplyr::select(symbol, company, date, actual = point.effect, 
                                         fitted = point.effect, lower = point.effect.lower, upper = point.effect.upper) %>%
              mutate(facet_var = "Stock: Actual - Expected")) %>%
  mutate(hline = if_else(facet_var == "Stock: Actual - Expected", 0, NA_real_))

graph_tbl %>% ggplot(aes(x = date)) + 
  geom_vline(xintercept = start_event, linetype = 1, colour = "#808080") + geom_line(aes(y = hline)) +
  geom_line(aes(y = fitted), linetype = "dashed") + geom_line(aes(y = actual), colour = "#e31a1c", size = 0.5) +
  geom_ribbon(aes(ymin = lower, ymax = upper), fill = "#BFBFBF", alpha = 0.5) +
  facet_grid(facet_var ~ ., scales = "free_y") + AonECM::ggThemeAon() + scale_color_tq() +
  theme(panel.spacing = unit(1.5, "lines")) + ylab(NULL) + xlab(NULL) +
  ggtitle('Actual vs. Estimated Stock Price', subtitle = "Impact of Harvey")

```

# Overall results

Use DT::datable for summary. Highlight that we can show for which companies the event actually impacted stock price at various probability levels.

Include range of impact on stock price at Sept 1. Use a pointrange plot to graph.


```{r causal-impact-2, cache=TRUE}

causal_models <- stock_prices %>% #filter(symbol %in% stock_tickers$symbol[1:20]) %>%
  group_by(symbol, company, sector, industry, market_cap) %>% nest() %>%
  mutate(model = map(data, ~run_causal_impact(.x))) %>% dplyr::select(-data)

causal_models <- causal_models %>% 
  mutate(model_summary = map(model, ~ as_tibble(.x$summary[2,]))) %>% 
  unnest(model_summary)

```

```{r output}

causal_models %>% arrange(AbsEffect)


```

