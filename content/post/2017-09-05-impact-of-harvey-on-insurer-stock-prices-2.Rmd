---
title: Impact of Harvey on Insurer Stock Prices
author: ''
date: '2017-09-06'
slug: impact-of-harvey-on-insurer-stock-prices-2
categories: []
tags:
  - stocks
subtitle: ''
draft: true
---

```{r setup}

knitr::opts_chunk$set(
	# fig.align = "center",
	# fig.path = "figures/",
	message = FALSE,
	warning = FALSE,
	echo = FALSE 
)

library(tidyverse)
library(tidyquant)
library(CausalImpact)

```

```{r import-stock-prices, message=FALSE, warning=FALSE, cache=TRUE}

stock_tickers <- list('AMEX','NASDAQ','NYSE') %>% map_df(tq_exchange) %>% 
  filter(industry == 'Property-Casualty Insurers' & !is.na(market.cap)) %>%
  mutate(market_cap = if_else(stringr::str_sub(market.cap,start = -1)=="M",1e6,1e9) *
           as.numeric(stringr::str_sub(market.cap,start = 2, end = -2))) %>%
  dplyr::select(symbol, company, sector, industry, market_cap) %>%
  arrange(desc(market_cap))

  # dplyr::select(symbol, company, sector, industry) %>% 
  # tq_get(get = "key.stats", complete_cases = FALSE) %>% 
  # mutate(market_cap = map_dbl(key.stats, Market.Capitalization), 
  #        book_value = map_dbl(key.stats, Book.Value),
  #        price_to_book = map_dbl(key.stats, Price.to.Book)) %>%
  # select(-key.stats) %>%

stock_prices <- stock_tickers %>% tq_get(get = "stock.prices", from = '2017-01-01', to = '2017-09-01') %>%
  group_by(symbol) %>%
  tq_mutate(select = adjusted, mutate_fun = periodReturn, period = "daily", type = "log", col_rename = "daily_returns")

sp500_price <- tibble(symbol = "SPY") %>% tq_get(get = "stock.prices", 
                                                 from = '2017-01-01', to = '2017-09-01') %>%
  tq_mutate(select = adjusted, mutate_fun = periodReturn, period = "daily", type = "log", col_rename = "daily_returns")

sp500_price <- sp500_price %>% mutate(sp500 = adjusted, sp500_returns = daily_returns)
stock_prices <- stock_prices %>% left_join(sp500_price %>% dplyr::select(date, sp500, sp500_returns), by = "date")

```


```{r causal-impact-1}

run_causal_impact <- function(stock_data){
  
  model_data_mat <- stock_data %>% ungroup() %>% 
    mutate(var = if_else(daily_returns > 0.02, 1, 0)) %>%
    # dplyr::select(adjusted, sp500) %>%
    dplyr::select(daily_returns, sp500_returns, var) %>%
    as.matrix()
  
  impact_analysis <- CausalImpact(model_data_mat,
                                  pre.period = c(1, nrow(model_data_mat) - 7),
                                  post.period = c(nrow(model_data_mat)-7+1, nrow(model_data_mat)),
                                  model.args = list(niter = 1000, prior.level.sd = 0.1))
  
  impact_analysis
}

impact_model <- run_causal_impact(stock_prices %>% filter(symbol == "AXS"))

plot(impact_model)
summary(impact_model)
# plot(impact_analysis$model$bsts.model, y = "components")


```

```{r causal-impact-2, cache=TRUE}

causal_models <- stock_prices %>% #filter(symbol %in% stock_tickers$symbol[1:20]) %>%
  group_by(symbol, company, sector, industry, market_cap) %>% nest() %>%
  mutate(model = map(data, ~run_causal_impact(.x))) %>% dplyr::select(-data)

causal_models <- causal_models %>% 
  mutate(model_summary = map(model, ~ as_tibble(.x$summary[2,]))) %>% 
  unnest(model_summary)

```

```{r output}

causal_models %>% arrange(AbsEffect)


```

