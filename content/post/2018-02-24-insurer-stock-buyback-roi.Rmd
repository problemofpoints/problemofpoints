---
title: "P&C (Re)insurer Stock Buyback ROI"
subtitle: ''
date: '2018-03-21'
slug: insurer-stock-buyback-roi
tags:
  - insurance
  - stocks
draft: yes
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}

library(knitr)
library(AonInternal)
library(tidyverse)
library(readxl)
library(tibbletime)
library(lubridate)
library(tidyquant)
library(flextable)
library(AonECM)
library(officer)

knitr::opts_chunk$set(
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	echo = FALSE
)

AonInternal::SetTheme()
aon_colors <- c("#0083A9", "#808080", "#BFBFBF", "#5EB6E4", "#F0AB00", "#7AB800", 
                "#6E267B", "#BC5FCD","#E9CAEE", "#D3CD8B", "#7E7830", "#3E5B00", "#E11B22")

AonECM::ggSetTheme()

```

# Goal

The goal of this analysis is to calculate the historical return on investment (ROI) of share buybacks for P&C (re)insurance companies over the past 20 quarters (2013 - 2017). This is one way to measure whether companies have effectively allocated their capital to share buybacks. 

We split the buyback ROI into two components - buyback strategy and buyback effectiveness - to understand how well a company has timed their share repurchases.

# Data used

The data used for this analysis is from SEC Forms 10-Q and 10-K for each company over the time period of 2013 - 2017, per S&P Global Market Intelligence.

- Number of shares repurchased in the quarter
- Average price per share for shares repurchased
- Common shares outstanding
- Common dividend per share
- Special dividend per share
- Book value per share

Additionally, historical share price data was downloaded from Yahoo Finance.

```{r import-data}

data <- readxl::read_xlsx("data/insurer_buybacks.xlsx", sheet = "import") %>%
  gather(key = "statistic", value = "value", -ticker, -company) %>%
  separate(statistic, c("yr_qtr","metric"), sep = "_") %>%
  separate(yr_qtr, c("year","qtr"), sep = 4, remove = FALSE) %>%
  mutate(value = as.double(value), 
         year = as.double(year),
         date = lubridate::yq(yr_qtr), 
         qtr_ = lubridate::quarter(date)) %>%
  replace_na(list(value = 0)) %>% 
  spread(key = metric, value = value) %>%
  mutate(dollarrepurchase = avgpricepershare * sharesrepurchased)

```

```{r import-stock-prices}

# get a list of all the Property-Casualty Insurers from the major US stock exchanges
stock_tickers <- list('AMEX','NASDAQ','NYSE') %>% map_df(tq_exchange) %>% 
  filter((industry == 'Property-Casualty Insurers' | symbol %in% c("AGII", "ERIE", "AIZ")) & !is.na(market.cap)) %>%
  mutate(market_cap = if_else(stringr::str_sub(market.cap,start = -1)=="M",1e6,1e9) *
           as.numeric(stringr::str_sub(market.cap,start = 2, end = -2))) %>%
  dplyr::select(symbol, company, sector, industry, market_cap) %>%
  arrange(desc(market_cap))

stock_tickers <- stock_tickers %>% 
  inner_join(data %>% distinct(ticker), by = c("symbol"="ticker"))

# now get the historical stock prices for all of the tickers; get quarter close stock prices
stock_prices <- stock_tickers %>%
  tq_get(get = "stock.prices", from = "2010-01-01", to = "2017-12-31") %>% 
  filter(!is.na(adjusted)) %>% 
  select(symbol, company, market_cap, date, close, adjusted) 

stock_prices_qtr <- stock_prices %>%
  group_by(symbol) %>%
  as_tbl_time(index = date) %>%
  as_period("quarterly", side = "end") %>%
  mutate(year = lubridate::year(date), qtr_ = lubridate::quarter(date))

```

```{r combine-data}

data_to_use <- data %>% 
  select(-date) %>% 
  left_join(stock_prices_qtr %>% 
              select(symbol, market_cap, year, date, qtr_, close, adjusted), 
            by = c("ticker"="symbol", "year", "qtr_")) %>%
  drop_na() %>%
  group_by(ticker) %>%
  as_tbl_time(index = date) %>%
  filter_time('2013' ~ '2017')

data_to_use <- data_to_use %>%
  mutate(cum_shares_repurchased = cumsum(sharesrepurchased)) %>%
  mutate(cash_flow = -dollarrepurchase + (commondivpershare + specdivpershare) * cum_shares_repurchased,
         cash_flow_final = cash_flow + if_else(year == 2017 & qtr_ == 4, close * cum_shares_repurchased, 0),
         cash_flow_final2 = cash_flow + if_else(year == 2017 & qtr_ == 4, adjusted * cum_shares_repurchased, 0))

```

```{r calc-roi}

buyback_roi <- data_to_use %>% 
  summarise(n_qtrs = n(),
            market_cap = market_cap[1], init_shares = commonshares[1], 
            shares_repurchased = dplyr::last(cum_shares_repurchased), 
            dollar_repurchased = sum(dollarrepurchase), 
            pct_init_shares = shares_repurchased / init_shares, 
            pct_market_cap = sum(dollarrepurchase) / market_cap[1],
            tsr = ((sum((commondivpershare + specdivpershare) * commonshares) / dplyr::last(commonshares) + 
              dplyr::last(close)) / dplyr::first(close))^(1/(n_qtrs/4)) - 1,
            irr = (1+FinCal::irr(cash_flow_final))^4 - 1,
            buyback_effectiveness = (1+irr)/(1+tsr) - 1) %>%
  filter(pct_market_cap > 0.01) %>%
  arrange(desc(buyback_effectiveness))

```

# Methodology

The buyback ROI is calculated based on three items:

1. The cash outflows associated with share repurchases each quarter
2. The implied cash inflows of dividends (common and special) "saved" for the shares repurchased
3. A final cash inflow related to the total value of the cumulative shares repurchased


Walk through methodology using TRV as an example. Use graphs to show dollar repurchased, shares repurchased, net cash flows.

Create for every company...nice single slide summary.

Show graph of stock price with avg repurchase price as a line; number of shares repurchased below it. Ideally include pb ratio graph also...

Bar graphs with quarterly cash flows - stacked to see impact of repurchase + dividends

```{r company-example}

company_example <- data_to_use %>%
  filter(ticker == "TRV")

company_example %>%
  ggplot(aes(x = date, y = commonshares)) +
  geom_col()

company_example %>%
  ggplot(aes(x = date, y = sharesrepurchased)) +
  geom_col()

company_example %>%
  ggplot(aes(x = date, y = cum_shares_repurchased)) +
  geom_col()

company_example %>%
  ggplot(aes(x = date, y = cash_flow_final)) +
  geom_col()

```

# Overall results

A few graphs or tables (datatable?) summarizing results for each company. Add any interesting commments.

```{r summary-roi}

buyback_roi

```








